---
title: "Alternative plots"
author: "Jay Achar"
date: "2/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
suppressMessages(library(tidyverse))
library(here)
library(ggdist)
```

```{r source-functions}
files <- list.files(here("R"))
walk(files, 
     ~source(here("R", .x)))
```

```{r read-prepare-data}
const <- constants()
raw <- read_data("notifications")
dd <- prepare_data(raw)
```


## Comparing 2019 to 2020

```{r diff-data}
diff_data <- dd$long$region %>% 
        filter(age_group %in% const$age_groups[1:3]) %>% 
        group_by(g_whoregion, age_group, year) %>% 
        summarise(cases = sum(cases)) %>% 
        mutate(diff = cases - lag(cases),
               percent = round(cases / lag(cases) * 100, 1)) %>% 
        filter(!is.na(diff))

global_diff_data <- diff_data %>% 
        group_by(age_group, year) %>% 
        summarise(cases = sum(cases)) %>% 
        mutate(diff = cases - lag(cases),
               percent = round(cases / lag(cases) * 100, 1)) %>% 
        filter(!is.na(diff))
```

```{r diff-line-plot}
        diff_plot <- ggplot(diff_data,
                aes(x = year,
                    y = percent)
        ) +
        geom_line(aes(group = g_whoregion,
                      color = g_whoregion), alpha = 0.2) +
        geom_point(data = global_diff_data, color = "red") +
        geom_line(data = global_diff_data, color = "red", alpha = 0.5) +
        geom_hline(yintercept = 100, alpha = 0.6) +
        coord_cartesian(ylim = c(50, 150)) +
        facet_grid(age_group ~ .) + 
        labs(y = "Percent change on previous year",
             title = "Percentage change in TB notifications by age, WHO region and globally")

ggsave("diff_plot.png", 
       plot = diff_plot,
       path = "~/Desktop/")

diff_plot
```

```{r}
ggplot(diff_data,
       aes(x = year,
           y = percent)) + 
        geom_point(
                mapping = aes(color = g_whoregion),
                alpha = 0.2) + 
        geom_point(data = global_diff_data, color = "red") +
        geom_line(data = global_diff_data, color = "red", alpha = 0.2) +
        geom_hline(yintercept = 100,
                   color = "black") +
        facet_grid(age_group ~ .) +
        coord_flip(ylim = c(50, 150))
        
```

```{r}
dd$long$region %>% 
        group_by(g_whoregion, year, age_group) %>% 
        pivot_wider(names_from = sex, 
                    values_from = cases) %>% 
        mutate(ratio = m / f) %>% 
        ggplot(
                aes(x = ratio,
                    y = age_group)
        ) + 
        geom_point() + 
        facet_grid(g_whoregion ~ .)
        
```

# Notes

* Can we show which countries having missing data over the course of the study?
* Fable package for flame?
* Be clear on how we're aggregating across age categories?
* Send PD a data frame with ISO3 codes and percentage change between 2019 and 2020

* Lasith - point to the country specific change plot in the code?
