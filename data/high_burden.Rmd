---
title: "Data for the high burden countries only"
output: html_notebook
---

AIM: TB data for just the high burden countries

```{r}
library(dplyr)
library(tidyverse)

setwd("~/Desktop/AFP/modV3/data")
high_burden <- big_data[big_data$country %in% c("Angola", "Bangladesh", "Brazil", "China", "Democratic People's Republic of Korea", "Democratic Republic of the Congo", "Ethiopia", "India", "Indonesia", "Kenya", "Mozambique", "Myanmar", "Nigeria", "Pakistan", "Philippines", "Russian Federation", "South Africa", "Thailand", "United Republic of Tanzania", "Viet Nam", "Cambodia", "Central African Republic", "Congo", "Lesotho", "Liberia", "Namibia", "Papua New Guinea", "Sierra Leone", "Zambia", "Zimbabwe"), ]
pop <- read_csv("pop_data.csv")

burden_yearly1 <- high_burden[order(high_burden$iso3), ] 
burden_yearly2 <- burden_yearly1[order(burden_yearly1$year), ]
burden_yearly2 <- burden_yearly2[, -c(5:10)] ##Removing columns for EPTB as no data available 
burden_yearly2 <- burden_yearly2[, -c(6,7,12,13,18:20)]
```

Filtering the population data 

```{r}
library(tidyr)
colnames(pop) <- c("Country", "iso3", "series", "series_code", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")

pop$`2013` <- as.numeric(pop$`2013`)
pop$`2014` <- as.numeric(pop$`2014`)
pop$`2015` <- as.numeric(pop$`2015`)
pop$`2016` <- as.numeric(pop$`2016`)
pop$`2017` <- as.numeric(pop$`2017`)
pop$`2018` <- as.numeric(pop$`2018`)
pop$`2019` <- as.numeric(pop$`2019`)
pop$`2020` <- as.numeric(pop$`2020`)

#Pivoting data to create data frame that can be merged with the high burden data frame 

pivot <- pivot_longer(pop, c("2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020"), names_to = "Year")

pivot2 <- pivot_wider(pivot, id_cols = c("Country", "iso3", "Year"), names_from = "series", values_from = "value")

pivot3 <- pivot2[-c(241:264), -17]

#Ordering the data by year 
pivot3$Year <- as.numeric(pivot3$Year)

pop_order1 <- pivot3[order(pivot3$iso3), ]
pop_order2 <- pop_order1[order(pop_order1$Year), ]

colnames(pop_order2)[colnames(pop_order2) == "Year"] <- "year"
```

Creating data frame with world bank population data and the age and sex disaggregated TB notification data 

```{r}
tb_pop <- merge(burden_yearly2, pop_order2, by = c("iso3", "year"))

tb_pop <- tb_pop[, -14]
```

Creating additional columns for 5-14 years male and female 

```{r}
colnames(tb_pop) <- c("iso3", "year", "country", "g_whoregion", "newrel_m04", "newrel_m514", "newrel_m014", "newrel_m15plus", "newrel_f04", "newrel_f514", "newrel_f014", "newrel_f15plus", "newrel_hivpos", "pop_f04", "pop_m04", "pop_014%", "pop_f014", "pop_m014", "pop_tot014", "pop_f59", "pop_m59", "pop_f1014", "pop_m1014", "pop_tot", "pop_male", "pop_female")

tb_pop$pop_m59 <- as.numeric(tb_pop$pop_m59)
tb_pop$pop_m1014 <- as.numeric(tb_pop$pop_m1014)
tb_pop$pop_f59 <- as.numeric(tb_pop$pop_f59)
tb_pop$pop_f1014 <- as.numeric(tb_pop$pop_f1014)
pop_new1 <- mutate(tb_pop, "pop_m514" = pop_m59 + pop_m1014, "pop_f514" = pop_f59 + pop_f1014)

pop_new2 <- pop_new1[, c(1:15, 20:23, 27, 28, 17, 18, 16, 19, 26, 25, 24)]
```

Expressing incidence per 100,000 in each age group 

```{r}
pop_new2$pop_f04 <- as.numeric(pop_new2$pop_f04)
pop_new2$pop_m04 <- as.numeric(pop_new2$pop_m04)
pop_new2$pop_f014 <- as.numeric(pop_new2$pop_f014)
pop_new2$pop_m014 <- as.numeric(pop_new2$pop_m014)
pop_new2$`pop_014%` <- as.numeric(pop_new2$`pop_014%`)
pop_new2$pop_tot014 <- as.numeric(pop_new2$pop_tot014)
pop_new2$pop_female <- as.numeric(pop_new2$pop_female)
pop_new2$pop_male <- as.numeric(pop_new2$pop_male)
pop_new2$pop_tot <- as.numeric(pop_new2$pop_tot)

pop_100k <- mutate(pop_new2, "tb_m04_100k" = newrel_m04/(pop_m04/100000), "tb_f04_100k" = newrel_f04/(pop_f04/100000), "tb_m514_100k" = newrel_m514/(pop_m514/100000), "tb_f514_100k" = newrel_f514/(pop_f514/100000))
```

Adding columns for total male, female and combined TB incidence for all ages 

```{r}
tot_pop_100k <- mutate(pop_100k, "newrel_mtot" = newrel_m014 + newrel_m15plus, "newrel_ftot" = newrel_f014 + newrel_f15plus, "newrel_TOT" = newrel_mtot + newrel_ftot)

tot_pop_100k <- tot_pop_100k[, c(1:13, 33:35, 29:32, 14:23, 25:28)]
tot_pop_100k2 <- mutate(tot_pop_100k, "tb_m_100k" = newrel_mtot/(pop_male/100000), "tb_f_100k" = newrel_ftot/(pop_female/100000), "tb_tot_100k" = newrel_TOT/(pop_tot/100000))

tb_100k <- tot_pop_100k2[, c(1:20, 35:37, 21:34)]

```

Adding column for percentage of TB notifications in children 0-4 and 0-14 as percentage of total TB notifications 

```{r}
perc_tb_100k <- mutate(tb_100k, "perc_tb04" = ((newrel_m04 + newrel_f04)/newrel_TOT)*100, "perc_tb014" = ((newrel_m014 + newrel_f014)/newrel_TOT)*100)

```

Adding column for percentage of TB notifications in children 0-4 as percentage of TB notifications in children 0-14 

```{r}
perc_tb_final <- mutate(perc_tb_100k, "perc_youngkids" = 100 * ((newrel_m04 + newrel_f04)/(newrel_m014 + newrel_f014)))
```

Exporting the file as CSV 

```{r}
write.csv(perc_tb_final, file = "tb_cleaned_notifs.csv")
```

Including version of the data grouped by WHO region 

```{r}
omitsum <- function(x){ 
        sum(na.omit(x))}

africa_2013 <- perc_tb_final %>% filter(g_whoregion == "AFR")  %>% filter(year == 2013) %>% select(c("newrel_m04", "newrel_m514", "newrel_m014", "newrel_m15plus", "newrel_f04", "newrel_f514", "newrel_f014", "newrel_f15plus", "newrel_hivpos", "newrel_mtot", "newrel_ftot", "newrel_TOT", "pop_f04", "pop_m04", "pop_f59", "pop_m59", "pop_f1014", "pop_m1014", "pop_m514", "pop_f514", "pop_f014", "pop_m014", "pop_tot014", "pop_female", "pop_male", "pop_tot")) %>% apply(MARGIN = 2, FUN = omitsum) %>% as.data.frame()




