---
title: "Generate prediction data"
author: 'Jay Achar'
date: "`r Sys.time()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressMessages(library(tidyverse))
library(here)
library(forecast)
```

```{r load, message=FALSE, warning=FALSE }
files <- list.files(here("R"))
walk(files,
     ~source(here("R", .x)))

const <- constants()

raw <- read_data("notifications")
```

```{r restructure-data}
dd <- prepare_data(raw, const = const)
```

## Missing values

Find all timeseries with missing values to all imputation.

```{r extract-missing-values}
# extract all time series with zero values
missing <- dd$long$country %>%
        filter(iso3 %in% const$high_burden) %>%
        filter(year >= 2014,
               year != 2020,
               age_group != "014") %>%
        mutate(age_group = factor(
                age_group,
                levels = c("04", "514", "15plus"),
                ordered = TRUE
        )) %>% 
        select(iso3, year, sex, age_group, cases) %>% 
        group_by(iso3, sex, age_group) %>% 
        nest() %>% 
        filter(map_lgl(data, function(d) {
                any(d$cases == 0 | is.na(d$cases))
        })) %>% 
        unnest(cols = c(data)) %>% 
        ungroup() %>% 
        mutate(cases = ifelse(cases == 0,
                              NA_integer_, 
                              cases))

saveRDS(missing,
        file = here::here("artefacts/missing.rds"))

```

```{r handle-missing-data}
clean <- prepare_long_data(dd)
```

## Predict 2020 notifications

Predictions should be performed on the most granular data available.
In this analysis, that is country and regional level data by age group and sex.

```{r create-predicted-data }
# create training data
## remove 2020
forecasts <- bind_rows(clean, 
          .id = "type") %>% 
  filter(year != 2020) %>% 
  group_by(location, age_group, type, sex) %>% 
## nest data by location & age group
  nest() %>% 
## create time-series
  mutate(ts = map(data,
                  function(series) {
                    select(series, -year) %>% 
                      ts(start = 2014, frequency = 1)
                  })) %>% 
  forecast_next_year(order = c(2, 0, 0),
                     drift = TRUE,
                     lambda = NULL,
                     log_transform = TRUE)

```

```{r extract-predictions}

predictions <- forecasts %>% 
  mutate(prediction = map(forecast, function(series) {
    data.frame(
      point = as.integer(series$point),
      lower95 = as.integer(series$lower95),
      upper95 = as.integer(series$upper95)
    )
  })) %>% 
  select(type, location, age_group, sex, prediction) %>% 
  unnest(cols = c(prediction))

# required for supp table 4
saveRDS(predictions,
        file = here::here("artefacts/predictions.rds"))
head(predictions)
```

## Problem

Some of the predictions are negative: 

```{r}
predictions %>% 
  filter(point <= 0 | lower95 <= 0)
```

